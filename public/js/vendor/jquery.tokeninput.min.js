/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.6.0
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */

(function(b){var C,z,O={method:"GET",contentType:"json",queryParam:"q",searchDelay:300,minChars:1,propertyToSearch:"name",jsonContainer:null,hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",animateDropdown:!0,tokenLimit:null,tokenDelimiter:",",preventDuplicates:!1,tokenValue:"id",prePopulate:null,processPrePopulate:!1,idPrefix:"token-input-",resultsFormatter:function(b){return"<li>"+b[this.propertyToSearch]+"</li>"},tokenFormatter:function(b){return"<li><p>"+
b[this.propertyToSearch]+"</p></li>"},onResult:null,onAdd:null,onDelete:null,onReady:null},D={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"};C=0;z=1;var v=
{init:function(h,k){var a=b.extend({},O,k||{});return this.each(function(){b(this).data("tokenInputObject",new b.TokenList(this,h,a))})},clear:function(){this.data("tokenInputObject").clear();return this},add:function(b){this.data("tokenInputObject").add(b);return this},remove:function(b){this.data("tokenInputObject").remove(b);return this},get:function(){return this.data("tokenInputObject").getTokens()}};b.fn.tokenInput=function(b){return v[b]?v[b].apply(this,Array.prototype.slice.call(arguments,
1)):v.init.apply(this,arguments)};b.TokenList=function(h,k,a){function t(){null!==a.tokenLimit&&l>=a.tokenLimit&&(g.hide(),q())}function K(e){var d=a.tokenFormatter(e),d=b(d).addClass(a.classes.token).insertBefore(r);b("<span>"+a.deleteText+"</span>").addClass(a.classes.tokenDelete).appendTo(d).click(function(){A(b(this).parent());j.change();return!1});var c={id:e.id};c[a.propertyToSearch]=e[a.propertyToSearch];b.data(d.get(0),"tokeninput",e);m=m.slice(0,n).concat([c]).concat(m.slice(n));n++;v(m,
j);l+=1;null!==a.tokenLimit&&l>=a.tokenLimit&&(g.hide(),q());return d}function E(e){var d=a.onAdd;if(0<l&&a.preventDuplicates){var c=null;s.children().each(function(){var a=b(this),d=b.data(a.get(0),"tokeninput");if(d&&d.id===e.id)return c=a,!1});if(c){y(c);r.insertAfter(c);g.focus();return}}if(null==a.tokenLimit||l<a.tokenLimit)K(e),t();g.val("");q();b.isFunction(d)&&d.call(j,e)}function y(b){b.addClass(a.classes.selectedToken);f=b.get(0);g.val("");q()}function w(b,d){b.removeClass(a.classes.selectedToken);
f=null;d===C?(r.insertBefore(b),n--):d===z?(r.insertAfter(b),n++):(r.appendTo(s),n=l);g.focus()}function A(e){var d=b.data(e.get(0),"tokeninput"),c=a.onDelete,x=e.prevAll().length;x>n&&x--;e.remove();f=null;g.focus();m=m.slice(0,x).concat(m.slice(x+1));x<n&&n--;v(m,j);l-=1;null!==a.tokenLimit&&g.show().val("").focus();b.isFunction(c)&&c.call(j,d)}function v(e,d){var c=b.map(e,function(b){return b[a.tokenValue]});d.val(c.join(a.tokenDelimiter))}function q(){u.hide().empty();p=null}function B(){u.css({position:"absolute",
top:b(s).offset().top+b(s).outerHeight(),left:b(s).offset().left,zindex:999}).show()}function F(e,d){if(d&&d.length){u.empty();var c=b("<ul>").appendTo(u).mouseover(function(a){G(b(a.target).closest("li"))}).mousedown(function(a){E(b(a.target).closest("li").data("tokeninput"));j.change();return!1}).hide();b.each(d,function(d,g){var f=a.resultsFormatter(g),f=f.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+g[a.propertyToSearch]+")(?![^<>]*>)(?![^&;]+;)","g"),g[a.propertyToSearch].replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+
e+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")),f=b(f).appendTo(c);d%2?f.addClass(a.classes.dropdownItem):f.addClass(a.classes.dropdownItem2);0===d&&G(f);b.data(f.get(0),"tokeninput",g)});B();a.animateDropdown?c.slideDown("fast"):c.show()}else a.noResultsText&&(u.html("<p>"+a.noResultsText+"</p>"),B())}function G(e){e&&(p&&(b(p).removeClass(a.classes.selectedDropdownItem),p=null),e.addClass(a.classes.selectedDropdownItem),p=e.get(0))}function L(){var e=g.val().toLowerCase();e&&e.length&&(f&&w(b(f),
z),e.length>=a.minChars?(a.searchingText&&(u.html("<p>"+a.searchingText+"</p>"),B()),clearTimeout(M),M=setTimeout(function(){var d=e+H(),c=I.get(d);if(c)F(e,c);else if(a.url){var c=H(),f={data:{}};-1<c.indexOf("?")?(c=c.split("?"),f.url=c[0],c=c[1].split("&"),b.each(c,function(a,b){var e=b.split("=");f.data[e[0]]=e[1]})):f.url=c;f.data[a.queryParam]=e;f.type=a.method;f.dataType=a.contentType;a.crossDomain&&(f.dataType="jsonp");f.success=function(c){b.isFunction(a.onResult)&&(c=a.onResult.call(j,c));
I.add(d,a.jsonContainer?c[a.jsonContainer]:c);g.val().toLowerCase()===e&&F(e,a.jsonContainer?c[a.jsonContainer]:c)};b.ajax(f)}else a.local_data&&(c=b.grep(a.local_data,function(b){return-1<b[a.propertyToSearch].toLowerCase().indexOf(e.toLowerCase())}),b.isFunction(a.onResult)&&(c=a.onResult.call(j,c)),I.add(d,c),F(e,c))},a.searchDelay)):q())}function H(){var b=a.url;"function"==typeof a.url&&(b=a.url.call());return b}"string"===b.type(k)||"function"===b.type(k)?(a.url=k,k=H(),void 0===a.crossDomain&&
(a.crossDomain=-1===k.indexOf("://")?!1:location.href.split(/\/+/g)[1]!==k.split(/\/+/g)[1])):"object"===typeof k&&(a.local_data=k);a.classes?a.classes=b.extend({},D,a.classes):a.theme?(a.classes={},b.each(D,function(b,d){a.classes[b]=d+"-"+a.theme})):a.classes=D;var m=[],l=0,I=new b.TokenList.Cache,M,J,g=b('<input type="text"  autocomplete="off">').css({outline:"none"}).attr("id",a.idPrefix+h.id).focus(function(){if((null===a.tokenLimit||a.tokenLimit!==l)&&a.hintText)u.html("<p>"+a.hintText+"</p>"),
B()}).blur(function(){q();b(this).val("")}).bind("keyup keydown blur update",function(){if(J!==(J=g.val())){var b=J.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");N.html(b);g.width(N.width()+30)}}).keydown(function(a){var d,c;switch(a.keyCode){case 37:case 39:case 38:case 40:if(b(this).val())return d=null,d=40===a.keyCode||39===a.keyCode?b(p).next():b(p).prev(),d.length&&G(d),!1;d=r.prev();c=r.next();d.length&&d.get(0)===f||c.length&&c.get(0)===f?37===a.keyCode||
38===a.keyCode?w(b(f),C):w(b(f),z):(37===a.keyCode||38===a.keyCode)&&d.length?y(b(d.get(0))):(39===a.keyCode||40===a.keyCode)&&c.length&&y(b(c.get(0)));break;case 8:d=r.prev();if(b(this).val().length)1===b(this).val().length?q():setTimeout(function(){L()},5);else return f?(A(b(f)),j.change()):d.length&&y(b(d.get(0))),!1;break;case 9:case 13:case 108:case 188:if(p)return E(b(p).data("tokeninput")),j.change(),!1;break;case 27:return q(),!0;default:String.fromCharCode(a.which)&&setTimeout(function(){L()},
5)}}),j=b(h).hide().val("").focus(function(){g.focus()}).blur(function(){g.blur()}),f=null,n=0,p=null,s=b("<ul />").addClass(a.classes.tokenList).click(function(a){if((a=b(a.target).closest("li"))&&a.get(0)&&b.data(a.get(0),"tokeninput")){var d=f;f&&w(b(f),2);d===a.get(0)?w(a,2):y(a)}else f&&w(b(f),2),g.focus()}).mouseover(function(e){(e=b(e.target).closest("li"))&&f!==this&&e.addClass(a.classes.highlightedToken)}).mouseout(function(e){(e=b(e.target).closest("li"))&&f!==this&&e.removeClass(a.classes.highlightedToken)}).insertBefore(j),
r=b("<li />").addClass(a.classes.inputToken).appendTo(s).append(g),u=b("<div>").addClass(a.classes.dropdown).appendTo("body").hide(),N=b("<tester/>").insertAfter(g).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:g.css("fontSize"),fontFamily:g.css("fontFamily"),fontWeight:g.css("fontWeight"),letterSpacing:g.css("letterSpacing"),whiteSpace:"nowrap"});j.val("");h=a.prePopulate||j.data("pre");a.processPrePopulate&&b.isFunction(a.onResult)&&(h=a.onResult.call(j,h));h&&h.length&&b.each(h,
function(a,b){K(b);t()});b.isFunction(a.onReady)&&a.onReady.call();this.clear=function(){s.children("li").each(function(){0===b(this).children("input").length&&A(b(this))})};this.add=function(a){E(a)};this.remove=function(a){s.children("li").each(function(){if(0===b(this).children("input").length){var d=b(this).data("tokeninput"),c=!0,f;for(f in a)if(a[f]!==d[f]){c=!1;break}c&&A(b(this))}})};this.getTokens=function(){return m}};b.TokenList.Cache=function(h){var k=b.extend({max_size:500},h),a={},t=
0;this.add=function(b,h){t>k.max_size&&(a={},t=0);a[b]||(t+=1);a[b]=h};this.get=function(b){return a[b]}}})(jQuery);